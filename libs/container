#!/bin/bash
#----------------------------------------------------------------------------------
#
#   –ü—Ä–æ–µ–∫—Ç: –ú–æ–ª–æ—Ç [molot]
# 
#   –§–∞–π–ª –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∏ÃÜ–Ω–µ—Ä–∞–º–∏ 
#   –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –≤ —Ñ–∞–π–ª–µ build.me
# 
#   –ê–≤—Ç–æ—Ä       : –ñ–µ–ª–µ–∑–∞
#   Email       : dev@zeleza.ru
#   –õ–∏—Ü–µ–Ω–∑–∏—è    : Apache –í–µ—Ä—Å–∏—è 2.0
#
#   –°–æ–∑–¥–∞–Ω      : 27 –æ–∫—Ç—è–±—Ä—è 2024 –≥–æ–¥
#   –û–±–Ω–æ–≤–ª–µ–Ω    : 30 –æ–∫—Ç—è–±—Ä—è 2024 –≥–æ–¥
# 
#----------------------------------------------------------------------------------

# –í–∫–ª—é—á–∞–º —Ä–µ–∂–∏–º –≤—ã–≤–æ–¥–∞ –æ—Ç–ª–∞–¥–æ—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
# set -x

#----------------------------------------------------------------------------------
# –ü—Ä–µ–º–µ–Ω–Ω–∞—è DEBUG - —Ñ–ª–∞–≥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏: 
# 	0 - –≤—ã–∫–ª—é—á–µ–Ω–æ, 1 - –≤–∫–ª—é—á–µ–Ω–æ—ã
# 	–ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω–æ–º —Ñ–ª–∞–≥–µ –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω—ã—Ö 
# 	—Ñ—É–Ω–∫—Ü–∏–π —Å–±–æ—Ä–∫–∏ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –æ—Ç–ª–∞–¥–∫–∏
# 	–≤ –∫–æ—Ç–æ—Ä–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ —Å–±–æ—Ä–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã –≤ –≤–∏–¥–µ –∑–∞–≥–ª—É—à–µ–∫
#----------------------------------------------------------------------------------
DEBUG=0
#----------------------------------------------------------------------------------

# –ò–º—è —Ñ–∞–π–ª–∞ –¥–ª—è —Ñ–∞–π–ª–∞ –∫–æ—Ç–æ—Ä—ã–π —Ö—Ä–∞–Ω–∏—Ç 
# –∫—Ä–∞–π–Ω—é—é —Å—Ç–∞–¥–∏—é —Å–±–æ—Ä–∫–∏, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ
BUILDED_STAGES_FILE="${HOME}/${APP_NAME}/.stages"

# set -x
# –ü—É—Ç—å –∫ entware
BUILDING_ENV_PATH="${HOME}/${BUILDING_ENV}"

# –ú–∞—Å—Å–∏–≤ —Ñ—É–Ω–∫—Ü–∏–π —Å—Ç–∞–¥–∏–π c–±–æ—Ä–∫–∏
STAGES_FUNC_NAME=(
	stage1_clone_github_entware_repo
	stage2_refresh_symlinks
	stage3_make_menuconfig
	stage4_build_toolchain
	stage5_build_package
	stage6_copy_package_to_project_dir
	stage7_copy_package_to_router
	stage8_install_and_start_package_on_router
)

# –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É –æ—Ç–ª–∞–¥–∫–∏ 
# –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ—Å–ª–µ 
# –æ–±—ä—è–≤–ª–µ–Ω–∏—è –º–∞—Å—Å–∏–≤–∞ STAGES_FUNC_NAME 
[ ${DEBUG} -eq 1 ] && source ${HOME}/molot/libs/debuger 


# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∞–¥–∏–π –ø–æ —Ä–∞–∑–º–µ—Ä—É –º–∞—Å—Å–∏–≤–∞
TOTAL_STAGES=${#STAGES_FUNC_NAME[@]}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ç–∞–¥–∏–∏ —Å –∏–Ω–¥–µ–∫—Å–∞ start –¥–æ end
run_stages() {
# set -xe
    local _start=$1
    local _end=$2
    for (( i=_start; i<_end; i++ )); do
        ${STAGES_FUNC_NAME[i]} || return 1
    done
}

make_ssh_key() {

	# –°–æ–∑–¥–∞–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á
	[ -f ${HOME}/.ssh/id_rsa.pub ] || {
		[ -d ${HOME}/.ssh ] || sudo mkdir -p ${HOME}/.ssh
		header "–°–æ–∑–¥–∞–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á–∏..."
		sudo ssh-keygen -q -t rsa -b 4096 -f ${HOME}/.ssh/id_rsa -N "" || {
			error "–í–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª—é—á–µ–π"
			return 1
		}
	}
	return 0
}

has_access_to_remote_host() {

	# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –ø–æ SSH
	
    local ssh_login="$1"
    local port="$2"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –ø–æ SSH
	ssh -o BatchMode=yes -o ConnectTimeout=5 -p "$port" "$ssh_login" "exit" &> /dev/null || {
		return 1
	}
	return 0

 
}

copy_ssh_key() {

    # –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–æ—Å—Ç—å —Ä–æ—É—Ç–µ—Ä–∞ 
	local _host=$(echo "${1//root@/}" | tr -d ' ')
	local _port="${2:-22}"

    if is_host_available "${_host}" ; then
		
		# –µ—Å–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–æ—É—Ç–µ—Ä—É, —Ç–æ –∫–æ–ø–∏—Ä—É–µ–º –∫–ª—é—á –Ω–∞ —Ä–æ—É—Ç–µ—Ä
		has_access_to_remote_host ${1} ${_port} || {
			header "–†–æ—É—Ç–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω, –ø–µ—Ä–µ–¥–∞–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –Ω–∞ —Ä–æ—É—Ç–µ—Ä..."
			message "–ö–æ–≥–¥–∞ –∑–∞–ø—Ä–æ—Å—è—Ç, –≤–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å —Ä–æ—É—Ç–µ—Ä–∞:"
			message "–ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á: ${HOME}/.ssh/id_rsa.pub"
			print_line
			cat < ${HOME}/.ssh/id_rsa.pub
			print_line
			sudo ssh-copy-id -p ${_port} -i ${HOME}/.ssh/id_rsa.pub ${_host} || {
				error "–í–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞ –Ω–∞ —Ä–æ—É—Ç–µ—Ä"
			}
		}
  
    else
        error "–†–æ—É—Ç–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ ${_host}"
		return 1
    fi
	return 0
}

get_last_stage() {

	# –ü–æ–ª—É—á–∞–µ–º –Ω–æ–º–µ—Ä –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π —Å—Ç–∞–¥–∏–∏ —Å–±–æ—Ä–∫–∏

	local _start_stage

	if [ -f "${BUILDED_STAGES_FILE}" ] ; then 
		_start_stage=$(cat < ${BUILDED_STAGES_FILE})
		[ -z "${_start_stage}" ] && _start_stage=0
	else
		touch "${BUILDED_STAGES_FILE}"
		_start_stage=0
	fi

	echo ${_start_stage}

}

stage1_clone_github_entware_repo() {
# set -x
	# –ü–µ—Ä–≤—ã–π —ç—Ç–∞–ø —Å–±–æ—Ä–∫–∏ - –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
	header "–ö–ª–æ–Ω–∏—Ä—É–µ–º —Å—Ä–µ–¥—É —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ Entware –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è "

	[ -d ${BUILDING_ENV_PATH} ] && rm -rf ${BUILDING_ENV_PATH}
	# [ -d ${BUILDING_ENV_PATH} ] && cd ${BUILDING_ENV_PATH} #; make clean || true
	mkdir -p ${BUILDING_ENV_PATH} && cd ${HOME} &> /dev/null || true
	git clone ${REPO_URL} ${BUILDING_ENV_PATH} || {
		error "[–°—Ç–∞–¥–∏—è ‚Ññ1]: –í–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è Entware"
		return 1
	}
	
	# –§–∏–∫—Å–∏—Ä—É–µ–º —Å–±–æ—Ä–∫—É –ø–µ—Ä–≤–æ–≥–æ —ç—Ç–∞–ø–∞
	echo 1 > "${BUILDED_STAGES_FILE}"

	cd "${BUILDING_ENV_PATH}" && return 0
# set +x
}

stage2_refresh_symlinks() {
	
	# –í—Ç–æ—Ä–æ–π —ç—Ç–∞–ø —Å–±–æ—Ä–∫–∏ - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Å—ã–ª–æ–∫ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ø–∞–∫–µ—Ç–æ–≤
	print_line
	header "–û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ø–∞–∫–µ—Ç–æ–≤..."

	# –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ø–∞–∫–µ—Ç–æ–≤
	cd ${BUILDING_ENV_PATH} && git fetch	

	# –°–æ–±–∏—Ä–∞–µ–º –ø–∞–∫–µ—Ç—ã
	${BUILDING_ENV_PATH}/scripts/feeds update -a || {
		error "[–°—Ç–∞–¥–∏—è ‚Ññ2]: –í–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Å—ã–ª–æ–∫ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ø–∞–∫–µ—Ç–æ–≤"
		return 1
	}

	print_line
	header "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ø–∞–∫–µ—Ç–æ–≤..."

	${BUILDING_ENV_PATH}/scripts/feeds install -a || {
		error "[–°—Ç–∞–¥–∏—è ‚Ññ2]: –í–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ø–∞–∫–µ—Ç–æ–≤"
		return 1
	}
	
	print_line
	header "–û–±–Ω–æ–≤–ª—è–µ–º –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–ª—è –ø–∞–∫–µ—Ç–∞ ${BLUE}${APP_NAME}${NOCL}..."

	{
		grep -q ${APP_NAME} ${BUILDING_ENV_PATH}/.feeds 2>/dev/null || echo "src-link ${APP_NAME} ${BUILDING_ENV_PATH}/feeds/packages/${APP_NAME}" >> ${BUILDING_ENV_PATH}/.feeds
		ln -sf ${HOME}/${APP_NAME} ${BUILDING_ENV_PATH}/feeds/packages/
		${BUILDING_ENV_PATH}/scripts/feeds update packages ${APP_NAME}
		${BUILDING_ENV_PATH}/scripts/feeds install -a ${APP_NAME}
	} || {
		error "[–°—Ç–∞–¥–∏—è ‚Ññ2]: –í–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–ª—è –ø–∞–∫–µ—Ç–∞ ${BLUE}${APP_NAME}${NOCL}"
		return 1
	}

	# make package/symlinks || {
	# 	error "[–°—Ç–∞–¥–∏—è ‚Ññ2]: –í–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Å—ã–ª–æ–∫ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ø–∞–∫–µ—Ç–æ–≤"
	# 	return 1
	# }
	
	# –§–∏–∫—Å–∏—Ä—É–µ–º —Å–±–æ—Ä–∫—É –≤—Ç–æ—Ä–æ–≥–æ —ç—Ç–∞–ø–∞
	echo 2 > "${BUILDED_STAGES_FILE}"

	return 0
}

stage3_make_menuconfig() {
	
	# –¢—Ä–µ—Ç–∏–π —ç—Ç–∞–ø —Å–±–æ—Ä–∫–∏ - —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
	print_line
	header "–°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–æ–¥ ${BLUE}${BUILDING_ARCH}${NOCL}..."

	# ln -sf "$HOME/${APP_NAME}" ${BUILDING_ENV_PATH}/package/feeds/packages/
	# –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è –∑–∞–¥–∞–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
	cp -vf configs/${BUILDING_ARCH}-*.config .config
	grep -q kvaspro .config || echo "CONFIG_PACKAGE_kvaspro=m" >> .config

	# –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
	make defconfig || {
		error "[–°—Ç–∞–¥–∏—è ‚Ññ3]: –í–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
		return 1
	}

	# –§–∏–∫—Å–∏—Ä—É–µ–º —Å–±–æ—Ä–∫—É —Ç—Ä–µ—Ç—å–µ–≥–æ —ç—Ç–∞–ø–∞
	echo 3 > "${BUILDED_STAGES_FILE}"
	
	return 0
}

stage4_build_toolchain() {

	# –ß–µ—Ç–≤–µ—Ä—Ç—ã–∏ÃÜ —ç—Ç–∞–ø —Å–±–æ—Ä–∫–∏ - —Å–±–æ—Ä–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ä–∏—è toolchain
	clear && print_line
	header "–ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ä–∏—è ${BLUE}toolchain${NOCL}"

	make -j12 toolchain/install || {
		error "[–°—Ç–∞–¥–∏—è ‚Ññ4]: –í–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ ${BLUE}toolchain${NOCL}"
		make -j1 V=cs toolchain/install 
		print_line
		pause "–î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –Ω–∞–∂–º–∏—Ç–µ –∫–ª–∞–≤–∏—à—É Enter..."
		return 1
	}

	# –§–∏–∫—Å–∏—Ä—É–µ–º —Å–±–æ—Ä–∫—É —á–µ—Ç–≤–µ—Ä—Ç–æ–≥–æ —ç—Ç–∞–ø–∞
	echo 4 > "${BUILDED_STAGES_FILE}"

	return 0
}


stage5_build_package() {

	local answer="y"
	print_line
	header "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ä–∏–π ${BLUE}toolchain${NOCL} –±—ã–ª —Å–æ–±—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ."
	read_ynq "–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–±–æ—Ä–∫—É –ø–∞–∫–µ—Ç–∞ ${APP_NAME}?" answer
	
	# –í—ã—Ö–æ–¥–∏–º –∏–∑ —Å–∫—Ä–∏–ø—Ç–∞ –µ—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ –æ—Ç–º–µ–Ω—É –∏–ª–∏ –Ω–µ—Ç
	[[ "${answer}" = [NQ] ]] && return 1
	[ "${answer}" = Y ] && {

		# –ü—è—Ç—ã–∏ÃÜ —ç—Ç–∞–ø —Å–±–æ—Ä–∫–∏ - —Å–±–æ—Ä–∫–∞ –ø–∞–∫–µ—Ç–∞
		clear && print_line
		header "–ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É –ø–∞–∫–µ—Ç–∞ ${BLUE}${APP_NAME}${NOCL}"

		PATH=${BUILDING_ENV_PATH}/build_dir/host/bin:$PATH
		make -j12 package/${APP_NAME}/{clean,compile} || {
			error "[–°—Ç–∞–¥–∏—è ‚Ññ5]: –í–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ –ø–∞–∫–µ—Ç–∞ ${APP_NAME}"
			make -j1 V=cs package/${APP_NAME}/compile 
			print_line
			pause "–î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –Ω–∞–∂–º–∏—Ç–µ –∫–ª–∞–≤–∏—à—É Enter..." 
			return 1
		}
	}

	return 0
}

stage6_copy_package_to_project_dir() {

	print_line
	header "–ö–æ–ø–∏—Ä—É–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–π ipk –ø–∞–∫–µ—Ç –ø–∞–ø–∫—É ${BLUE}${HOME}/${APP_NAME}/packages/${BUILDING_ARCH}${NOCL}"

	# –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–π –ø–∞–∫–µ—Ç –≤ –ø–∞–ø–∫—É —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
    [ -d "${HOME}/molot/${BUILDING_ARCH}" ] || mkdir -p ${HOME}/${APP_NAME}/packages/${BUILDING_ARCH}/

	# –ü–æ–ª—É—á–∞–µ–º –∏–º—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞ –∏ —Å—É—Ñ—Ñ–∏–∫—Å–∞
	arch_conf=$(ls configs/aarch* | sed 's|.*/\(.*\)\..*$|\1|')

    # –ö–æ–ø–∏—Ä—É–µ–º –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞ —Å–æ–±—Ä–∞–Ω–Ω—ã–π –ø–∞–∫–µ—Ç
    cp ${BUILDING_ENV_PATH}/bin/targets/${arch_conf}/generic-glibc/packages/${APP_NAME}_*.ipk ${HOME}/${APP_NAME}/packages/${BUILDING_ARCH}/ || {
		error "[–°—Ç–∞–¥–∏—è ‚Ññ6]: –í–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ –ø–∞–∫–µ—Ç–∞ –Ω–∞ —Ä–æ—É—Ç–µ—Ä"
		return 1
	}
	return 0
}

stage7_copy_package_to_router() {
    
	# –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–π –ø–∞–∫–µ—Ç –≤ –ø–∞–ø–∫—É —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Ä–æ—É—Ç–µ—Ä

	# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
	make_ssh_key 
	# –ö–æ–ø–∏—Ä—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –Ω–∞ —Ä–æ—É—Ç–µ—Ä
	copy_ssh_key ${ROUTER_SSH} ${ROUTER_PORT}

	# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ä–æ—É—Ç–µ—Ä–∞ 
    if is_host_available "${ROUTER_SSH}" ; then
        message "–†–æ—É—Ç–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω, –ø–µ—Ä–µ–¥–∞–µ–º –ø–∞–∫–µ—Ç –Ω–∞ —Ä–æ—É—Ç–µ—Ä..."
		ssh -p ${ROUTER_PORT} ${ROUTER_SSH} "[ -d /opt/packages ] || mkdir -p /opt/packages/" &> /dev/null || {
			error "[–°—Ç–∞–¥–∏—è ‚Ññ7]: –í–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ /opt/packages –Ω–∞ —Ä–æ—É—Ç–µ—Ä–µ"
            return 1
		}
        scp -OP ${ROUTER_PORT} "${HOME}/${APP_NAME}/packages/${BUILDING_ARCH}/${APP_NAME}_*.ipk" ${ROUTER_SSH}:/opt/packages/ || {
            error "[–°—Ç–∞–¥–∏—è ‚Ññ7]: –í–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ –ø–∞–∫–µ—Ç–∞ –Ω–∞ —Ä–æ—É—Ç–µ—Ä"
            return 1
        }
    else
        error "–†–æ—É—Ç–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É ${BLUE}${ROUTER_SSH//root@/}${NOCL}"
        return 1
    fi

	return 0
}


stage8_install_and_start_package_on_router() {
	
	# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Ä–æ—É—Ç–µ—Ä–µ

	clear && print_line
	header "–í—ã–ø–æ–ª–Ω—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É –ø–∞–∫–µ—Ç–∞ –∏ –∑–∞–ø—É—Å–∫ –Ω–∞ —Ä–æ—É—Ç–µ—Ä–µ..."

	ssh -p ${ROUTER_PORT} ${ROUTER_SSH} "[ -f /opt/packages/${APP_NAME}_*.ipk ] && rm -f /opt/packages/${APP_NAME}_*.ipk && \
		opkg remove ${APP_NAME} && opkg install /opt/packages/${APP_NAME}_*.ipk" || {
		error "[–°—Ç–∞–¥–∏—è ‚Ññ8]: –í–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –ø–∞–∫–µ—Ç–∞ –Ω–∞ —Ä–æ—É—Ç–µ—Ä ${BLUE}${ROUTER_SSH}${NOCL}"
			return 1
		}
	ssh -p ${ROUTER_PORT} ${ROUTER_SSH} "/opt/sbin/${APP_NAME}" || {
		error "[–°—Ç–∞–¥–∏—è ‚Ññ8]: –í–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ —Ä–æ—É—Ç–µ—Ä ${BLUE}${ROUTER_SSH}${NOCL}"
		return 1
		}
	ssh -p ${ROUTER_PORT} ${ROUTER_SSH} "/opt/sbin/test_${APP_NAME}" || {
		error "[–°—Ç–∞–¥–∏—è ‚Ññ8]: –í–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ —Ä–æ—É—Ç–µ—Ä ${BLUE}${ROUTER_SSH}${NOCL}"
		return 1
	}

	return 0
}


hello() {
	pause "–î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –Ω–∞–∂–º–∏—Ç–µ –∫–ª–∞–≤–∏—à—É Enter..."
    clear
    print_line
    echo
    echo -e "   üê≥ –°–µ–π—á–∞—Å –º—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
    echo
    echo -e "   ${BOLD}–°–æ–±–∏—Ä–∞–µ–º –ø–æ–¥${NOCL} : ${BLUE}${BUILDING_ENV}${NOCL}"
    echo -e "   ${BOLD}–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å${NOCL} : ${BLUE}${USER_NAME}${NOCL}"
    echo -e "   ${BOLD}–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ${NOCL}   : ${BLUE}${APP_NAME}${NOCL}"
    echo -e "   ${BOLD}–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞${NOCL}  : ${BLUE}${BUILDING_ARCH}${NOCL}"
    echo -e
	echo -e "   ${BOLD}–°–±–æ—Ä–∫–∞${NOCL}       : ${GREEN}build <N>${NOCL}, –≥–¥–µ N - –Ω–æ–º–µ—Ä —Å—Ç–∞–¥–∏–∏ —Å–±–æ—Ä–∫–∏"
    echo -e "   ${BOLD}–°–ø—Ä–∞–≤–∫–∞${NOCL}      : ${GREEN}help${NOCL}"
    echo -e "   ${BOLD}–í—ã—Ö–æ–¥${NOCL}        : ${GREEN}exit${NOCL}"
    echo
    print_line
}

set_bashrc_profile(){
#----------------------------------------------------------------------------------------------
# 
#   –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ —Å–µ—Å—Å–∏—é –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
# 
#---------------------------------------------------------------------------------------------

	(
        # —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
        printf "\n\nPS1=\"\nüê≥ \w ‚ú™‚ùØ \"\n" 

        printf 'export TERM=xterm-256color\n'
		printf 'export EDITOR="/usr/bin/nano"\n'
        printf "export LS_OPTIONS='--color=auto'\n";

        printf "alias grep='grep --color=auto'\n";
        printf "alias rm='rm -i'\n";
        printf "alias cp='cp -i'\n";
        printf "alias mv='mv -i'\n";
        printf "alias ls='ls $LS_OPTIONS -GFh'\n";
        printf "alias ll='ls $LS_OPTIONS -lai'\n";
        printf "alias l='ls $LS_OPTIONS -lA'\n";
        printf "alias nano='nano +999999 -l'\n";
		printf "alias build='${HOME}/molot/bin/builder'$@\n";

		printf "help() {\n"
		printf '    \n'
		printf "    BLUE=\"\e[36m\" \n"
		printf "    BOLD=\"\e[1m\"\n"
		printf "    GREEN=\"\e[32m\"\n"
		printf "    NOCL=\"\e[m\"\n"
		printf '    \n'
		printf "    while IFS= read -r line; do\n"
		printf '	eval "echo -e \\"${line}\\""\n'
		printf "    done < ${HOME}/molot/config/${BUILDING_ENV}/help\n"
		printf "}\n"

        printf "[ -d ${BUILDING_ENV_PATH} ] || mkdir -p ${BUILDING_ENV_PATH} && cd ${BUILDING_ENV_PATH}\n" 
		printf "${HOME}/molot/bin/builder\n"

	) > ${HOME}/.bash_aliases || {
		error "–ü—Ä–∏ –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–∞–π–ª ${BLUE}${HOME}/.bash_aliases${NOCL} –≤–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞."
		return 1
	}

	return 0
 
}


